name: Modulith Verification

on:
  push:
    branches: [main, develop, 'refactor/**']
  pull_request:
    branches: [main, develop]

jobs:
  verify-modules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Verify Module Structure
        run: mvn test -Dtest=ModularityTests -DfailIfNoTests=false
      
      - name: Check Shared Kernel Size
        run: |
          count=$(find src/main/java -path "*/shared/*" -name "*.java" ! -name "package-info.java" | wc -l)
          echo "ðŸ“Š Shared kernel class count: $count"
          echo ""
          echo "Thresholds:"
          echo "  âœ… Target: â‰¤ 10 classes"
          echo "  âš ï¸  Warning: > 15 classes"
          echo "  âŒ Critical: > 25 classes"
          echo ""
          echo "Note: Current count includes infrastructure classes (security, config, file upload)"
          echo "      that are intentionally shared across all modules."
          echo ""
          if [ $count -gt 25 ]; then
            echo "âŒ FAIL: Shared kernel has $count classes (> 25)!"
            echo "Action required: Refactor shared kernel to reduce size."
            exit 1
          elif [ $count -gt 15 ]; then
            echo "âš ï¸  WARNING: Shared kernel has $count classes (> 15)"
            echo "Consider refactoring to keep it under control."
          else
            echo "âœ… PASS: Shared kernel size is acceptable ($count classes)"
          fi
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/
